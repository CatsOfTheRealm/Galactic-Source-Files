package kabam.rotmg.pets.view {
import com.company.assembleegameclient.ui.DeprecatedTextButton;
import com.company.assembleegameclient.ui.dialogs.DialogCloser;

import flash.display.Sprite;
import flash.events.MouseEvent;

import kabam.lib.ui.api.Size;
import kabam.rotmg.pets.data.PetVO;
import kabam.rotmg.pets.data.ReskinViewState;
import kabam.rotmg.pets.util.PetsConstants;
import kabam.rotmg.pets.util.PetsViewAssetFactory;
import kabam.rotmg.pets.view.components.DialogCloseButton;
import kabam.rotmg.pets.view.components.PopupWindowBackground;
import kabam.rotmg.pets.view.dialogs.PetPicker;
import kabam.rotmg.text.model.TextKey;
import kabam.rotmg.text.view.TextFieldDisplayConcrete;
import kabam.rotmg.text.view.stringBuilder.LineBuilder;
import kabam.rotmg.ui.view.SignalWaiter;

import org.osflash.signals.Signal;
import org.osflash.signals.natives.NativeSignal;

public class PetFormView extends PetInteractionView implements DialogCloser {

    private static const closeDialogSignal:Signal = new Signal();

    private const background:PopupWindowBackground = PetsViewAssetFactory.returnFuserWindowBackground();
    private const titleTextfield:TextFieldDisplayConcrete = PetsViewAssetFactory.returnTopAlignedTextfield(0xB3B3B3, 18, true);
    private const closeButton:DialogCloseButton = PetsViewAssetFactory.returnCloseButton(PetsConstants.WINDOW_BACKGROUND_WIDTH);
    private const NUM_CATEGORIES:int = 3;
    public const closed:Signal = new Signal();
    public const skinGroupsInitialized:Signal = new Signal();
    public const reskinRequest:Signal = new Signal();

    private var petPickerContainer:Sprite;
    private var reskinContainer:Sprite;
    private var skinGroups:Vector.<PetSkinGroup>;
    private var posY:uint = 60;
    public var reskinButton:DeprecatedTextButton;
    public var reskinButtonClick:NativeSignal;
    public var skinGroupInitCount:uint = 0;

    public function PetFormView() {
        this.petPickerContainer = new Sprite();
        this.reskinContainer = new Sprite();
        this.reskinButton = new DeprecatedTextButton(14, TextKey.PET_RESKIN_BUTTON_CHOOSE);
        this.reskinButtonClick = new NativeSignal(this.reskinButton, MouseEvent.CLICK);
        super();
    }

    public function init():void {
        this.titleTextfield.setStringBuilder(new LineBuilder().setParams(TextKey.PET_RESKIN_TITLE));
        this.closeButton.clicked.add(this.onClose);
        this.reskinButtonClick.add(this.onReskinClick);
        this.reskinButton.textChanged.add(this.positionReskinButton);
        this.waitForTextChanged();
        this.addChildren();
        this.positionAssets();
    }

    private function onReskinClick(_arg1:MouseEvent):void {
        this.reskinRequest.dispatch();
    }

    public function createSkinGroups(_arg1:Vector.<PetSkinGroup>):void {
        var _local2:PetSkinGroup;
        var _local3:uint;
        while (_local3 < this.NUM_CATEGORIES) {
            _local2 = _arg1[_local3];
            this.skinGroups = _arg1;
            _arg1[_local3].initComplete.add(this.onSkinGroupInit);
            this.reskinContainer.addChild(_arg1[_local3]);
            _local3++;
        }
    }

    public function onSkinGroupInit() {
        this.skinGroupInitCount++;
        if (this.skinGroupInitCount == this.NUM_CATEGORIES) {
            this.positionSkinGroups();
            this.skinGroupsInitialized.dispatch();
        }
    }

    private function positionSkinGroups():void {
        var _local1:uint;
        _local1 = 0;
        while (_local1 < this.NUM_CATEGORIES) {
            this.skinGroups[_local1].x = 0;
            this.skinGroups[_local1].y = this.posY;
            this.posY = (this.posY + this.skinGroups[_local1].height);
            _local1++;
        }
        this.reskinButton.y = (this.posY + 10);
        this.background.height = (this.posY + 50);
    }

    public function createPetPicker(_arg1:PetPicker, _arg2:Vector.<PetVO>):void {
        _arg1.setSize(new Size((this.background.width - 10), 240));
        _arg1.setPadding(5);
        _arg1.setPetSize(52);
        _arg1.doDisableUsed = false;
        this.petPickerContainer.addChild(_arg1);
        this.petPickerContainer.x = 4;
        this.petPickerContainer.y = 35;
    }

    private function onFameOrGoldClicked():void {
        closeDialogSignal.dispatch();
    }

    private function addChildren():void {
        addChild(this.background);
        addChild(this.titleTextfield);
        addChild(this.closeButton);
        this.reskinContainer.addChild(this.reskinButton);
    }

    private function positionAssets():void {
        positionThis();
    }

    private function positionReskinButton():void {
        this.reskinButton.x = ((this.background.width - this.reskinButton.width) / 2);
        this.reskinButton.y = (this.background.height - (this.reskinButton.height + 10));
    }

    private function waitForTextChanged():void {
        var _local1:SignalWaiter = new SignalWaiter();
        _local1.push(this.titleTextfield.textChanged);
        _local1.complete.addOnce(this.positionTextField);
    }

    private function positionTextField():void {
        this.titleTextfield.y = 5;
        this.titleTextfield.x = ((PetsConstants.WINDOW_BACKGROUND_WIDTH - this.titleTextfield.width) * 0.5);
    }

    private function onClose():void {
        this.closed.dispatch();
    }

    public function getCloseSignal():Signal {
        return (closeDialogSignal);
    }

    public function setState(_arg1:String):void {
        if (_arg1 == ReskinViewState.PETPICKER) {
            addChild(this.petPickerContainer);
            if (contains(this.reskinContainer)) {
                removeChild(this.reskinContainer);
            }
        }
        else {
            if (_arg1 == ReskinViewState.SKINPICKER) {
                addChild(this.reskinContainer);
                if (contains(this.petPickerContainer)) {
                    removeChild(this.petPickerContainer);
                }
            }
        }
    }


}
}
